#! /usr/bin/env node
'use strict';

let version = process.argv[2];

if (!version) {
  throw new Error('Provide a new version (vX.X.X)')
} else if (version[0] !== 'v') {
  console.log('hello');
  version = 'v' + version
}


const exec = require('child_process').exec,
      write = require('fs').writeFileSync;

['bower.json', 'package.json'].forEach(file => {
  const pkg = require(`./${file}`)
  pkg.version = version.substring(1);
  write(`./${file}`, JSON.stringify(pkg, null, 2), 'utf-8');
})

const loop = (commands) => {
  if (commands && commands.length) {
    const stream = exec(commands.shift())
    stream.stdout.on('data', (data) => console.log(data));
    stream.stderr.on('data', (error) => {
      console.error(error);
    });
    stream.on('exit', () => loop(commands));
  }
}

loop([
  'gulp build',
  'git add -A',
  'git commit -m ' + version,
  'git tag ' + version,
  'git push',
  'git push --tags',
  'npm publish'
])
